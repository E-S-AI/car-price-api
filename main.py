# -*- coding: utf-8 -*-
"""main.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1t4-JuNSKCYN2ln-Lu1LzIjkIBMViUxSZ
"""

from fastapi import FastAPI, HTTPException, Form
import joblib
import pandas as pd
from contextlib import asynccontextmanager

# --- Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ùˆ Lifespan ---
@asynccontextmanager
async def lifespan(app: FastAPI):
    try:
        app.state.model = joblib.load("model/best_car_price_predictor_model.joblib")
        app.state.model_columns = joblib.load("model/model_columns.joblib")
        app.state.known_models = [
            col.replace('model_', '')
            for col in app.state.model_columns if col.startswith('model_')
        ]
        print("âœ… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙˆØ§Ù„Ø£Ø¹Ù…Ø¯Ø© ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­.")
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬: {e}")
        app.state.model = None
    yield
    print("ğŸ”š Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.")

app = FastAPI(
    title="ğŸš— Car Price Prediction API",
    description="Ù†Ù…ÙˆØ°Ø¬ ØªÙˆÙ‚Ø¹ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… FastAPI",
    lifespan=lifespan
)

# --- Ù†Ù‚Ø·Ø© Ø§Ù„ØªÙˆÙ‚Ø¹ ---
@app.post("/predict")
def predict_price(
    brand: str = Form(...),
    model_name: str = Form(...),
    year: int = Form(...),
    mileage: int = Form(...),
    engine_size: float = Form(...),
    cylinder: int = Form(...),
    fuel_type: str = Form(...),
    transmission: str = Form(...)
):
    if app.state.model is None:
        raise HTTPException(status_code=503, detail="Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ØºÙŠØ± Ø¬Ø§Ù‡Ø².")

    # ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    input_data = {
        "brand": brand,
        "model_name": model_name,
        "year": year,
        "mileage": mileage,
        "engine_size": engine_size,
        "cylinder": cylinder,
        "fuel_type": fuel_type,
        "transmission": transmission
    }

    if input_data["model_name"] not in app.state.known_models:
        input_data["model_name"] = "Other_Model"

    input_data["model"] = input_data.pop("model_name")
    input_df = pd.DataFrame([input_data])
    input_encoded = pd.get_dummies(input_df, drop_first=True, dtype=int)

    # Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    final_input = pd.DataFrame(columns=app.state.model_columns, index=[0]).fillna(0.0)
    for col in input_encoded.columns:
        if col in final_input.columns:
            final_input.at[0, col] = input_encoded.at[0, col]

    # Ø§Ù„ØªÙ†Ø¨Ø¤
    predicted_price = float(app.state.model.predict(final_input)[0])
    formatted_price = f"${max(0, predicted_price):,.2f}"
    return {"estimated_price_usd": formatted_price}